{
    "sourceFile": "New folder/app/src/features/sale-panel/AddNote.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1747690376862,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1747690417188,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,255 @@\n+import styled from \"styled-components\";\n+import { useEffect, useState } from \"react\";\n+\n+const StyledOrderNotes = styled.div`\n+  h3 {\n+    margin-bottom: 3rem;\n+  }\n+  ul {\n+    max-height: 300px;\n+    overflow-y: auto;\n+    margin-bottom: 2rem;\n+    padding-right: 1rem;\n+  }\n+  li {\n+    margin-bottom: 2rem;\n+    padding-bottom: 1rem;\n+    border-bottom: 1px solid #ccc;\n+  }\n+  .note-header {\n+    display: flex;\n+    justify-content: space-between;\n+    margin-bottom: 0.5rem;\n+  }\n+  .panel-label {\n+    font-weight: bold;\n+    color: #555;\n+  }\n+  .note-date {\n+    font-size: 0.85rem;\n+    color: #888;\n+  }\n+  .add-button {\n+    margin-top: 1rem;\n+    padding: 0.5rem 1rem;\n+    background-color: #28a745;\n+    color: white;\n+    border: none;\n+    border-radius: 4px;\n+    cursor: pointer;\n+  }\n+  form {\n+    display: flex;\n+    flex-direction: column;\n+  }\n+  textarea {\n+    resize: vertical;\n+    min-height: 80px;\n+    padding: 0.5rem;\n+    margin-bottom: 1rem;\n+    font-size: 1rem;\n+  }\n+  .error-message {\n+    color: red;\n+    margin-bottom: 1rem;\n+  }\n+  button {\n+    padding: 0.5rem 1rem;\n+    margin-right: 0.5rem;\n+    border: none;\n+    border-radius: 4px;\n+    cursor: pointer;\n+  }\n+  .submit-button {\n+    background-color: #28a745;\n+    color: white;\n+  }\n+  .cancel-button {\n+    background-color: #ccc;\n+    color: #333;\n+  }\n+`;\n+\n+const panelLabels = {\n+  sales: \"فروش\",\n+  financial: \"مالی\",\n+  execution: \"اجرا\",\n+};\n+\n+function OrderNotesWrapper({ orderId, panel = \"sales\" }) {\n+  const [notes, setNotes] = useState([]);\n+  const [loading, setLoading] = useState(false);\n+  const [error, setError] = useState(null);\n+  const [showAddNote, setShowAddNote] = useState(false);\n+\n+  const fetchNotes = async () => {\n+    setLoading(true);\n+    setError(null);\n+    try {\n+      const tokenData = JSON.parse(localStorage.getItem(\"token\"));\n+      const token = tokenData?.access;\n+\n+      if (!token) throw new Error(\"توکن یافت نشد\");\n+\n+      const response = await fetch(\n+        \"https://amin-beton-back.chbk.app/api/order-management/get-order-notes/\",\n+        {\n+          method: \"POST\",\n+          headers: {\n+            \"Content-Type\": \"application/json\",\n+            Authorization: `Bearer ${token}`,\n+          },\n+          body: JSON.stringify({ order_id: orderId }),\n+        }\n+      );\n+\n+      if (!response.ok) throw new Error(\"خطا در دریافت یادداشت‌ها\");\n+\n+      const data = await response.json();\n+      setNotes(data);\n+    } catch (err) {\n+      setError(err.message || \"خطای ناشناخته\");\n+    } finally {\n+      setLoading(false);\n+    }\n+  };\n+\n+  useEffect(() => {\n+    if (orderId) fetchNotes();\n+  }, [orderId]);\n+\n+  // اینجا فقط فرم اضافه کردن یادداشت هست و ارسال یادداشت همینجا انجام میشه\n+  function AddNoteForm({ onCancel, onSuccess, panel }) {\n+    const [noteText, setNoteText] = useState(\"\");\n+    const [loading, setLoading] = useState(false);\n+    const [error, setError] = useState(null);\n+\n+    const handleSubmit = async (e) => {\n+      e.preventDefault();\n+      if (!noteText.trim()) {\n+        setError(\"متن یادداشت نمی‌تواند خالی باشد\");\n+        return;\n+      }\n+\n+      setLoading(true);\n+      setError(null);\n+\n+      try {\n+        const tokenData = JSON.parse(localStorage.getItem(\"token\"));\n+        const token = tokenData?.access;\n+        if (!token) throw new Error(\"توکن یافت نشد\");\n+\n+        console.log(\"Sending note with data:\", {\n+          order: orderId,\n+          panel: panel,\n+          text: noteText.trim(),\n+        });\n+\n+        const response = await fetch(\n+          \"https://amin-beton-back.chbk.app/api/order-management/add-note/\",\n+          {\n+            method: \"POST\",\n+            headers: {\n+              \"Content-Type\": \"application/json\",\n+              Authorization: `Bearer ${token}`,\n+            },\n+            body: JSON.stringify({\n+              order: orderId,\n+              panel: panel,\n+              text: noteText.trim(),\n+            }),\n+          }\n+        );\n+\n+        if (!response.ok) {\n+          const errData = await response.json();\n+          throw new Error(\n+            errData.text ? errData.text.join(\", \") : \"خطا در ثبت یادداشت\"\n+          );\n+        }\n+\n+        onSuccess();\n+      } catch (err) {\n+        setError(err.message);\n+      } finally {\n+        setLoading(false);\n+      }\n+    };\n+\n+    return (\n+      <form onSubmit={handleSubmit}>\n+        <textarea\n+          value={noteText}\n+          onChange={(e) => setNoteText(e.target.value)}\n+          placeholder=\"متن یادداشت را وارد کنید\"\n+          rows={5}\n+          required\n+        />\n+        {error && <p className=\"error-message\">{error}</p>}\n+        <div>\n+          <button type=\"submit\" className=\"submit-button\" disabled={loading}>\n+            {loading ? \"در حال ارسال...\" : \"ثبت یادداشت\"}\n+          </button>\n+          <button\n+            type=\"button\"\n+            className=\"cancel-button\"\n+            onClick={onCancel}\n+            disabled={loading}\n+          >\n+            لغو\n+          </button>\n+        </div>\n+      </form>\n+    );\n+  }\n+\n+  const handleNoteAdded = () => {\n+    setShowAddNote(false);\n+    fetchNotes();\n+  };\n+\n+  if (loading) return <p>در حال بارگذاری...</p>;\n+  if (error) return <p>خطا: {error}</p>;\n+\n+  return (\n+    <StyledOrderNotes>\n+      {!showAddNote && (\n+        <>\n+          <ul>\n+            {notes.length === 0 ? (\n+              <p>یادداشتی ثبت نشده است.</p>\n+            ) : (\n+              notes.map((note) => (\n+                <li key={note.id}>\n+                  <div className=\"note-header\">\n+                    <span className=\"panel-label\">\n+                      {panelLabels[note.panel] || note.panel}\n+                    </span>\n+                    <span className=\"note-date\">\n+                      {new Date(note.created_at).toLocaleString(\"fa-IR\")}\n+                    </span>\n+                  </div>\n+                  <p>{note.text}</p>\n+                </li>\n+              ))\n+            )}\n+          </ul>\n+\n+          <button className=\"add-button\" onClick={() => setShowAddNote(true)}>\n+            افزودن یادداشت\n+          </button>\n+        </>\n+      )}\n+\n+      {showAddNote && (\n+        <AddNoteForm\n+          panel={panel}\n+          onCancel={() => setShowAddNote(false)}\n+          onSuccess={handleNoteAdded}\n+        />\n+      )}\n+    </StyledOrderNotes>\n+  );\n+}\n+\n+export default OrderNotesWrapper;\n"
                }
            ],
            "date": 1747690376862,
            "name": "Commit-0",
            "content": ""
        }
    ]
}